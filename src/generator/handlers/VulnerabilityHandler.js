'use strict';

const Play = require('../Play');
const vmaas = require('../../external/vmaas');
const disambiguator = require('../disambiguator');
const TEMPLATE = require('../templates/static').vulnerabilities.errata;
const contentServerResolver = require('../templates/resolvers/ContentServerResolver');

const VMAAS_PATTERN = /^RH[SBE]A-20[\d]{2}:[\d]{4,5}$/;

exports.application = 'vulnerabilities';

exports.createPlay = function (issue) {
    if (VMAAS_PATTERN.test(issue.id.issue)) {
        return handleErratumBased(issue);
    }

    return handleRuleBasedIssue(issue);
};

async function handleErratumBased ({id, hosts}) {
    const erratum = await vmaas.getErratum(id.issue);

    if (erratum) {
        return new Play(id, TEMPLATE.apply({ERRATA: id.issue}), hosts);
    }

}

async function handleRuleBasedIssue ({id, hosts, resolution}) {
    const templates = await contentServerResolver.resolveTemplates(id);

    // TODO get metadata

    if (templates.length) {
        const template = disambiguator.disambiguate(templates, resolution, id);
        return new Play(id, template, hosts);
    }
}
