'use strict';

const P = require('bluebird');
const errors = require('../../errors');
const ErratumPlay = require('../plays/ErratumPlay');
const ResolutionPlay = require('../plays/ResolutionPlay');
const vulnerabilities = require('../../connectors/vulnerabilities');
const disambiguator = require('../../resolutions/disambiguator');
const erratumResolver = require('../../resolutions/resolvers/erratumResolver');
const contentServerResolver = require('../../resolutions/resolvers/contentServerResolver');

const VMAAS_PATTERN = /^RH[SBE]A-20[\d]{2}:[\d]{4,5}$/;

exports.application = 'vulnerabilities';

exports.createPlay = function (issue) {
    if (VMAAS_PATTERN.test(issue.id.issue)) {
        return handleErratumBased(issue);
    }

    return handleRuleBasedIssue(issue);
};

async function handleErratumBased ({id, hosts, resolution}) {
    const resolutions = await erratumResolver.resolveResolutions(id);

    if (!resolutions.length) {
        throw errors.unknownIssue(id);
    }

    const disambiguatedResolution = disambiguator.disambiguate(resolutions, resolution, id);
    const description = `${disambiguatedResolution.erratum.synopsis} (${id.issue})`;
    return new ErratumPlay(id, hosts, disambiguatedResolution, description);
}

async function handleRuleBasedIssue ({id, hosts, resolution}) {
    const [resolutions, rule] = await P.all([
        contentServerResolver.resolveResolutions(id),
        vulnerabilities.getRule(id.issue)
    ]);

    if (!rule) {
        throw errors.unknownIssue(id);
    }

    if (!resolutions.length) {
        throw errors.unsupportedIssue(id);
    }

    const disambiguatedResolution = disambiguator.disambiguate(resolutions, resolution, id);
    return new ResolutionPlay(id, hosts, disambiguatedResolution, rule.description);
}

exports.getResolver = function (id) {
    if (VMAAS_PATTERN.test(id.issue)) {
        return erratumResolver;
    }

    return contentServerResolver;
};
