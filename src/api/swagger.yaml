---
swagger: "2.0"
info:
  description: Insights Remediations Service
  version: "1"
  title: Insights Remediations
  contact:
    email: jozef@redhat.com
basePath: /v1
consumes:
  - application/json
produces:
  - application/json
  - text/plain
  - text/html
tags:
  - name: "generator"
    description: "Ansible Playbook Generator"
  - name: "remediations"
    description: "Stored Remediations"
  - name: "resolutions"
    description: "Information about available Ansible resolutions"
  - name: "diagnosis"
    description: "Host-specific detailed diagnosis information"


paths:
  /playbook:
    post:
      tags:
        - generator
      summary: Generate an Ansible Playbook
      description: Generates an Ansible Playbook based on input parameters
      operationId: generate
      produces:
        - text/vnd.yaml
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: "#/definitions/PlaybookDefinition"
      responses:
        200:
          description: OK
          schema:
            type: string
        400:
          $ref: '#/responses/BadRequest'

  /remediations:
    get:
      tags:
        - remediations
      summary: List Remediations
      description: Provides information about Remediations
      operationId: listRemediations
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/RemediationList'
    post:
      tags:
        - remediations
      summary: Create Remediation
      description: Creates a new Remediation based on given information
      operationId: createRemediation
      parameters:
        - name: body
          in: body
          required: true
          schema:
            $ref: '#/definitions/RemediationInput'
      responses:
        201:
          description: Created
          schema:
            $ref: '#/definitions/Remediation'
        400:
          $ref: '#/responses/BadRequest'

  /remediations/{id}:
    get:
      tags:
        - remediations
      summary: Get Remediation
      description: Provides information about the given Remediation
      operationId: getRemediation
      parameters:
        - $ref: '#/parameters/RemediationId'
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/Remediation'
        404:
          $ref: '#/responses/NotFound'
    delete:
      tags:
        - remediations
      summary: Remove Remediation
      description: Removes the given Remediation
      operationId: deleteRemediation
      parameters:
        - $ref: '#/parameters/RemediationId'
      responses:
        204:
          $ref: '#/responses/Deleted'
        404:
          $ref: '#/responses/NotFound'

  /resolutions/{issue}:
    get:
      tags:
        - resolutions
      summary: Resolution metadata
      description: Provides information about resolutions available for the given issue
      operationId: resolutions
      parameters:
        - $ref: '#/parameters/IssueId'
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/Resolutions'
        404:
          description: Issue not known or Ansible resolution not available

  /diagnosis/{system}:
    get:
      tags:
        - diagnosis
      summary: host-specific diagnosis
      description: Provides host-specific diagnosis information
      operationId: diagnosis
      parameters:
        - $ref: '#/parameters/SystemId'
      responses:
        200:
          description: OK
          schema:
            $ref: '#/definitions/Diagnosis'
        404:
          description: System not found


parameters:
  IssueId:
    in: path
    name: issue
    type: string
    required: true
    description: Issue identifier (e.g. `vulnerabilities:CVE_2017_6074_kernel|KERNEL_CVE_2017_6074`)
  RemediationId:
    in: path
    name: id
    type: string
    required: true
    description: Remediation identifier
    format: uuid
  SystemId:
    in: path
    name: system
    type: string
    required: true
    description: System identifier
    format: uuid


responses:
  BadRequest:
    description: Bad Request
    schema:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
  Deleted:
    description: Entity was deleted
  NotFound:
    description: Entity Not Found


definitions:
  IssueId:
    type: string
    pattern: ^(advisor|vulnerabilities|compliance|test):[\w\d-_|:]+$
    example: vulnerabilities:CVE_2017_5461_nss|CVE_2017_5461_NSS_2

  SystemId:
    type: string
    example: a8799a02-8be9-11e8-9eb6-529269fb1459

  ResolutionType:
    type: string
    example: fix
    default: fix

  PlaybookDefinition:
    type: object
    additionalProperties: false
    required:
      - issues
    properties:
      issues:
        type: array
        minItems: 1
        example:
          - id: advisor:bond_config_issue|BOND_CONFIG_ISSUE
            systems:
              - a8799a02-8be9-11e8-9eb6-529269fb1459
              - 736ef48c-8f05-11e8-9eb6-529269fb1459
          - id: vulnerabilities:CVE_2017_6074_kernel|KERNEL_CVE_2017_6074
            systems:
              - a8799a02-8be9-11e8-9eb6-529269fb1459
              - 736ef48c-8f05-11e8-9eb6-529269fb1459
            resolution: mitigate
          - id: compliance:sshd_disable_root_login
            systems:
              - a8799a02-8be9-11e8-9eb6-529269fb1459
              - 736ef48c-8f05-11e8-9eb6-529269fb1459
          - id: vulnerabilities:RHSA-2018:0502
            systems:
              - a8799a02-8be9-11e8-9eb6-529269fb1459
              - 736ef48c-8f05-11e8-9eb6-529269fb1459
          - id: vulnerabilities:RHSA-2017:1852
            systems:
              - a8799a02-8be9-11e8-9eb6-529269fb1459
              - 736ef48c-8f05-11e8-9eb6-529269fb1459
          - id: vulnerabilities:RHBA-2007:0331
            systems:
              - a8799a02-8be9-11e8-9eb6-529269fb1459
              - 736ef48c-8f05-11e8-9eb6-529269fb1459
        items:
          type: object
          additionalProperties: false
          required:
            - id
            - systems
          properties:
            id:
              $ref: "#/definitions/IssueId"
            systems:
              type: array
              minItems: 1
              items:
                $ref: "#/definitions/SystemId"
            resolution:
              $ref: "#/definitions/ResolutionType"

  RemediationList:
    type: object
    additionalProperties: false
    properties:
      remediations:
        type: array
        items:
          $ref: '#/definitions/Remediation'

  Remediation:
    type: object
    additionalProperties: false
    properties:
      id:
        type: string
        format: uuid
        example: 9197ba55-0abc-4028-9bbe-269e530f8bd5
      name:
        $ref: '#/definitions/RemediationName'

  RemediationInput:
    type: object
    additionalProperties: false
    properties:
      name:
        $ref: '#/definitions/RemediationName'

  RemediationName:
    type: string
    example: Fix Critical CVEs


  Resolutions:
    type: object
    properties:
      id:
        $ref: "#/definitions/IssueId"
      riskOfChange:
        $ref: '#/definitions/RiskOfChange'
      resolutions:
        type: array
        items:
          type: object
          properties:
            id:
              $ref: '#/definitions/ResolutionId'
            description:
              type: string
              example: Disable DCCP kernel module
            needsReboot:
              type: boolean
            riskOfChange:
              $ref: '#/definitions/RiskOfChange'

  ResolutionId:
    type: string
    example: 'fix'

  RiskOfChange:
    type: integer
    enum:
      - -1
      - 1
      - 2
      - 3
      - 4
    example: 2

  Diagnosis:
    type: object
    properties:
      diagnosis:
        type: object
        example:
          CVE_2018_1111_dhcp|ERROR_CVE_2018_1111_DHCP_2:
            dhcp_devs:
              - enp0s3
          CVE_2017_5753_4_cpu_kernel|KERNEL_CVE_2017_5753_4_CPU_ERROR_3:
            debugfs_available: true
            dmesg_available: true
            dmesg_wrapped: false
